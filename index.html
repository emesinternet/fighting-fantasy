<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fighting Fantasy Companion</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 16px;
    }
    h1 {
      margin-bottom: 8px;
    }
    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .starting-stats {
      font-size: 0.95rem;
      background: #f1f1f1;
      padding: 6px 10px;
      border-radius: 6px;
    }
    .layout {
      display: flex;
      gap: 16px;
    }
    .column {
      flex: 1;
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 4px;
    }
    .section {
      margin-bottom: 12px;
    }
    .enemy-box {
      border: 1px solid #ddd;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    label {
      display: block;
      margin-top: 6px;
    }
    textarea {
      width: 100%;
      min-height: 40px;
    }
    .actions {
      margin: 12px 0;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .log {
      border: 1px solid #ccc;
      padding: 8px;
      min-height: 60px;
      white-space: pre-line;
      background: #f9f9f9;
    }
    .potion-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      padding: 12px;
    }
    .modal {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      max-width: 760px;
      width: 100%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .grid-three {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin: 12px 0;
    }
    .option-card {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
      background: #fafafa;
    }
    .option-card.selected {
      border-color: #4a90e2;
      box-shadow: 0 0 0 2px #4a90e2;
      background: #f0f6ff;
    }
    .option-card h4 {
      margin: 0 0 4px 0;
    }
    .option-card p {
      margin: 4px 0;
      font-size: 0.9rem;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .helper-text {
      font-size: 0.85rem;
      color: #555;
    }
    button {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1 class="title-row">
    <span>Fighting Fantasy Companion</span>
    <span id="initialStatsDisplay" class="starting-stats">Starting Skill: - | Stamina: - | Luck: -</span>
  </h1>
  <button id="newGame">New Game</button>
  <div class="actions row">
    <button id="escape">Escape Combat</button>
    <button id="testLuck">Test Your Luck</button>
  </div>
  <div class="layout">
    <div class="column" id="adventureSheet">
      <h2>Adventure Sheet</h2>
      <div class="section">
        <label>Skill <input type="number" id="skill" value="0"></label>
        <label>Stamina <input type="number" id="stamina" value="0"></label>
        <label>Luck <input type="number" id="luck" value="0"></label>
      </div>
      <div class="section">
        <label>Gold Pieces <textarea id="gold"></textarea></label>
        <label>Treasures <textarea id="treasure"></textarea></label>
        <label>Equipment <textarea id="equipment"></textarea></label>
        <label>Provisions <textarea id="provisions"></textarea></label>
        <div class="row">
          <label>Meals <input type="number" id="meals" value="10" min="0"></label>
          <button id="eatMeal">Eat Meal</button>
        </div>
        <div class="potion-row">
          <span id="potionStatus">No potion selected.</span>
          <button id="usePotion">Use Potion</button>
        </div>
      </div>
    </div>
    <div class="column" id="monsters">
      <h2>Monster Encounters</h2>
      <div id="monsterList"></div>
    </div>
  </div>
  <div class="section">
    <h3>Log</h3>
    <div id="log" class="log"></div>
  </div>

  <script>
    // Core player state is tracked separately from the inputs so we can enforce maxima and potion effects.
    const player = {
      skill: 0,
      stamina: 0,
      luck: 0,
      maxSkill: 0,
      maxStamina: 0,
      maxLuck: 0,
      meals: 10,
      potion: null,
      potionUsed: false
    };

    // Track the unmodifiable starting maxima so we can surface them near the title.
    const initialStats = {
      skill: 0,
      stamina: 0,
      luck: 0
    };

    const enemies = Array.from({ length: 6 }, () => ({ skill: 0, stamina: 0 }));

    const logEl = document.getElementById('log');
    const initialStatsDisplay = document.getElementById('initialStatsDisplay');
    const potionStatus = document.getElementById('potionStatus');

    const inputs = {
      skill: document.getElementById('skill'),
      stamina: document.getElementById('stamina'),
      luck: document.getElementById('luck'),
      meals: document.getElementById('meals')
    };

    // Utility helpers --------------------------------------------------------
    const rollDice = (count) => Array.from({ length: count }, () => Math.floor(Math.random() * 6) + 1)
      .reduce((sum, value) => sum + value, 0);

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

    const logMessage = (message) => {
      const timestamp = new Date().toLocaleTimeString();
      logEl.textContent = `[${timestamp}] ${message}\n${logEl.textContent}`.trim();
    };

    const updateInitialStatsDisplay = () => {
      initialStatsDisplay.textContent = `Starting Skill: ${initialStats.skill || '-'} | Stamina: ${initialStats.stamina || '-'} | Luck: ${initialStats.luck || '-'}`;
    };

    // Lightweight modal scaffolding to keep dialog creation tidy.
    const createModal = (title, description) => {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      const modal = document.createElement('div');
      modal.className = 'modal';

      const heading = document.createElement('h3');
      heading.textContent = title;
      modal.appendChild(heading);

      if (description) {
        const desc = document.createElement('p');
        desc.textContent = description;
        modal.appendChild(desc);
      }

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      return { overlay, modal, close: () => overlay.remove() };
    };

    const syncPlayerInputs = () => {
      inputs.skill.value = player.skill;
      inputs.stamina.value = player.stamina;
      inputs.luck.value = player.luck;
      inputs.meals.value = player.meals;
      renderPotionStatus();
    };

    const bindPlayerInputs = () => {
      // Allow manual adjustments while keeping track of maxima for restoration effects.
      inputs.skill.addEventListener('change', () => {
        player.skill = parseInt(inputs.skill.value, 10) || 0;
        player.maxSkill = Math.max(player.maxSkill, player.skill);
      });
      inputs.stamina.addEventListener('change', () => {
        player.stamina = parseInt(inputs.stamina.value, 10) || 0;
        player.maxStamina = Math.max(player.maxStamina, player.stamina);
      });
      inputs.luck.addEventListener('change', () => {
        player.luck = parseInt(inputs.luck.value, 10) || 0;
        player.maxLuck = Math.max(player.maxLuck, player.luck);
      });
      inputs.meals.addEventListener('change', () => {
        player.meals = Math.max(0, parseInt(inputs.meals.value, 10) || 0);
        syncPlayerInputs();
      });
    };

    const renderPotionStatus = () => {
      if (!player.potion) {
        potionStatus.textContent = 'No potion selected.';
        return;
      }
      const used = player.potionUsed ? ' (used)' : '';
      potionStatus.textContent = `Potion: ${player.potion}${used}`;
    };

    const statConfigs = {
      skill: {
        label: 'Skill',
        roll: () => {
          const dice = rollDice(1);
          const total = dice + 6;
          return { total, detail: `${dice} + 6 = ${total}` };
        },
        helper: 'Roll 1D6 + 6'
      },
      stamina: {
        label: 'Stamina',
        roll: () => {
          const dice = rollDice(2);
          const total = dice + 12;
          return { total, detail: `${dice} + 12 = ${total}` };
        },
        helper: 'Roll 2D6 + 12'
      },
      luck: {
        label: 'Luck',
        roll: () => {
          const dice = rollDice(1);
          const total = dice + 6;
          return { total, detail: `${dice} + 6 = ${total}` };
        },
        helper: 'Roll 1D6 + 6'
      }
    };

    // Allow the player to roll each stat multiple times before accepting the spread.
    const showStatRollDialog = (onComplete) => {
      const { modal, close } = createModal('Roll Your Stats', 'Roll each stat as many times as you like, then start your adventure.');

      const grid = document.createElement('div');
      grid.className = 'grid-three';
      const applyButton = document.createElement('button');
      applyButton.textContent = 'Start Adventure';
      applyButton.disabled = true;

      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'Cancel';

      const currentRolls = { skill: null, stamina: null, luck: null };

      const updateApplyState = () => {
        applyButton.disabled = !Object.values(currentRolls).every((value) => value !== null);
      };

      Object.entries(statConfigs).forEach(([key, config]) => {
        const card = document.createElement('div');
        card.className = 'option-card';

        const title = document.createElement('h4');
        title.textContent = config.label;
        card.appendChild(title);

        const value = document.createElement('div');
        value.className = 'stat-value';
        value.textContent = '-';
        card.appendChild(value);

        const detail = document.createElement('p');
        detail.className = 'helper-text';
        detail.textContent = config.helper;
        card.appendChild(detail);

        const rollButton = document.createElement('button');
        rollButton.textContent = 'Roll';
        rollButton.addEventListener('click', () => {
          const result = config.roll();
          currentRolls[key] = result.total;
          value.textContent = result.total;
          detail.textContent = `Rolled ${result.detail}`;
          updateApplyState();
        });
        card.appendChild(rollButton);

        grid.appendChild(card);
      });

      modal.appendChild(grid);

      const actions = document.createElement('div');
      actions.className = 'modal-actions';
      actions.appendChild(cancelButton);
      actions.appendChild(applyButton);
      modal.appendChild(actions);

      cancelButton.addEventListener('click', () => {
        close();
      });

      applyButton.addEventListener('click', () => {
        close();
        onComplete(currentRolls);
      });
    };

    const potionOptions = [
      { name: 'Potion of Skill', description: 'Restores Skill to its starting maximum when used.' },
      { name: 'Potion of Strength', description: 'Restores Stamina to its starting maximum when used.' },
      { name: 'Potion of Fortune', description: 'Restores Luck and increases your maximum Luck by 1.' }
    ];

    const showPotionDialog = (onSelect, onCancel) => {
      const { modal, close } = createModal('Choose Your Potion', 'Pick one potion to bring on your adventure.');
      const grid = document.createElement('div');
      grid.className = 'grid-three';
      let selected = null;

      const cards = potionOptions.map((option) => {
        const card = document.createElement('div');
        card.className = 'option-card';

        const heading = document.createElement('h4');
        heading.textContent = option.name;
        card.appendChild(heading);

        const info = document.createElement('p');
        info.textContent = option.description;
        card.appendChild(info);

        const chooseButton = document.createElement('button');
        chooseButton.textContent = 'Select';
        chooseButton.addEventListener('click', () => {
          selected = option.name;
          cards.forEach((c) => c.card.classList.remove('selected'));
          card.classList.add('selected');
        });
        card.appendChild(chooseButton);

        return { card };
      });

      cards.forEach(({ card }) => grid.appendChild(card));
      modal.appendChild(grid);

      const actions = document.createElement('div');
      actions.className = 'modal-actions';
      const confirmButton = document.createElement('button');
      confirmButton.textContent = 'Confirm';
      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'Cancel';

      cancelButton.addEventListener('click', () => {
        close();
        if (onCancel) {
          onCancel();
        }
      });
      confirmButton.addEventListener('click', () => {
        if (!selected) {
          alert('Please select a potion to continue.');
          return;
        }
        close();
        onSelect(selected);
      });

      actions.appendChild(cancelButton);
      actions.appendChild(confirmButton);
      modal.appendChild(actions);
    };

    // Player interactions ----------------------------------------------------
    const handleEatMeal = () => {
      if (player.meals <= 0) {
        alert('No meals left.');
        return;
      }
      player.meals -= 1;
      player.stamina = clamp(player.stamina + 4, 0, player.maxStamina);
      syncPlayerInputs();
      logMessage('You eat a meal and regain 4 Stamina.');
    };

    const escapeCombat = () => {
      if (!confirm('Are you sure you want to run away? You will lose 2 Stamina.')) {
        return;
      }
      player.stamina = clamp(player.stamina - 2, 0, player.maxStamina);
      syncPlayerInputs();
      logMessage('You escaped combat and lost 2 Stamina.');
    };

    // Luck handling ----------------------------------------------------------
    const testLuck = (context) => {
      if (player.luck <= 0) {
        alert('You have no Luck remaining.');
        return { outcome: 'none', lucky: false };
      }
      const roll = rollDice(2);
      const isLucky = roll <= player.luck;
      player.luck = Math.max(0, player.luck - 1);
      syncPlayerInputs();
      logMessage(`Testing Luck: rolled ${roll} vs Luck ${player.luck + 1}. ${isLucky ? 'Lucky!' : 'Unlucky.'}`);

      if (!context) {
        return { outcome: 'general', lucky: isLucky };
      }

      if (context.type === 'playerHitEnemy') {
        const enemy = enemies[context.index];
        const adjustment = isLucky ? -2 : 1;
        enemy.stamina = Math.max(0, enemy.stamina + adjustment);
        context.updateEnemyDisplay();
        logMessage(isLucky ? 'Lucky strike! Enemy loses an additional 2 Stamina.' : 'Unlucky! Enemy regains 1 Stamina.');
        if (enemy.stamina === 0) {
          resetEnemy(context.index);
        }
      } else if (context.type === 'playerHitByEnemy') {
        const adjustment = isLucky ? 1 : -1;
        player.stamina = clamp(player.stamina + adjustment, 0, player.maxStamina);
        syncPlayerInputs();
        logMessage(isLucky ? 'Lucky! You reduce the damage by gaining 1 Stamina.' : 'Unlucky! You lose an additional 1 Stamina.');
      }
      return { outcome: context.type, lucky: isLucky };
    };

    // Combat handling -------------------------------------------------------
    const performAttack = (index) => {
      const enemySkillInput = document.getElementById(`enemy-skill-${index}`);
      const enemyStaminaInput = document.getElementById(`enemy-stamina-${index}`);
      const enemySkill = parseInt(enemySkillInput.value, 10) || 0;
      const enemyStamina = parseInt(enemyStaminaInput.value, 10) || 0;

      if (enemySkill <= 0 || enemyStamina <= 0) {
        alert('Set enemy Skill and Stamina before attacking.');
        return;
      }

      enemies[index].skill = enemySkill;
      enemies[index].stamina = enemyStamina;

      const monsterAttack = rollDice(2) + enemySkill;
      const playerAttack = rollDice(2) + player.skill;

      logMessage(`Combat roll vs Enemy ${index + 1}: Monster ${monsterAttack} vs Player ${playerAttack}.`);

      if (monsterAttack === playerAttack) {
        logMessage('Standoff! No damage dealt.');
        return;
      }

      if (playerAttack > monsterAttack) {
        enemies[index].stamina = Math.max(0, enemyStamina - 2);
        logMessage('You hit the enemy for 2 damage.');
        const wantsLuck = confirm('You wounded the enemy. Use Luck for extra damage?');
        if (wantsLuck) {
          testLuck({ type: 'playerHitEnemy', index, updateEnemyDisplay: () => updateEnemyInputs(index) });
        }
      } else {
        player.stamina = clamp(player.stamina - 2, 0, player.maxStamina);
        syncPlayerInputs();
        logMessage('The enemy hits you for 2 damage.');
        const wantsLuck = confirm('You took damage. Use Luck to reduce it?');
        if (wantsLuck) {
          testLuck({ type: 'playerHitByEnemy', index, updateEnemyDisplay: () => updateEnemyInputs(index) });
        }
      }

      updateEnemyInputs(index);
      if (enemies[index].stamina === 0) {
        resetEnemy(index);
        logMessage(`Enemy ${index + 1} is defeated.`);
      }
    };

    const resetEnemy = (index) => {
      enemies[index] = { skill: 0, stamina: 0 };
      updateEnemyInputs(index);
    };

    const updateEnemyInputs = (index) => {
      document.getElementById(`enemy-skill-${index}`).value = enemies[index].skill;
      document.getElementById(`enemy-stamina-${index}`).value = enemies[index].stamina;
    };

    const buildMonsterBoxes = () => {
      const container = document.getElementById('monsterList');
      enemies.forEach((_, index) => {
        const box = document.createElement('div');
        box.className = 'enemy-box';
        box.innerHTML = `
          <strong>Enemy ${index + 1}</strong>
          <label>Skill <input type="number" id="enemy-skill-${index}" value="0"></label>
          <label>Stamina <input type="number" id="enemy-stamina-${index}" value="0"></label>
          <button id="attack-${index}">Attack</button>
        `;
        container.appendChild(box);
      });
    };

    // Game setup ------------------------------------------------------------
    const applyPotion = () => {
      if (!player.potion || player.potionUsed) {
        alert('No potion available or it has already been used.');
        return;
      }
      if (player.potion === 'Potion of Skill') {
        player.skill = player.maxSkill;
        logMessage('Potion of Skill used. Skill restored to max.');
      } else if (player.potion === 'Potion of Strength') {
        player.stamina = player.maxStamina;
        logMessage('Potion of Strength used. Stamina restored to max.');
      } else if (player.potion === 'Potion of Fortune') {
        player.maxLuck += 1;
        player.luck = player.maxLuck;
        logMessage('Potion of Fortune used. Luck increased and restored.');
        initialStats.luck = player.maxLuck;
        updateInitialStatsDisplay();
      }
      player.potionUsed = true;
      syncPlayerInputs();
      renderPotionStatus();
    };

    const selectPotion = () => {
      showPotionDialog((choice) => {
        player.potion = choice;
        player.potionUsed = false;
        logMessage(`${player.potion} selected.`);
        renderPotionStatus();
      }, () => {
        alert('Choose a potion to start your adventure.');
        selectPotion();
      });
    };

    const newGame = () => {
      showStatRollDialog((rolls) => {
        player.skill = player.maxSkill = rolls.skill;
        player.stamina = player.maxStamina = rolls.stamina;
        player.luck = player.maxLuck = rolls.luck;
        player.meals = 10;
        player.potion = null;
        player.potionUsed = false;

        initialStats.skill = rolls.skill;
        initialStats.stamina = rolls.stamina;
        initialStats.luck = rolls.luck;
        updateInitialStatsDisplay();

        document.getElementById('gold').value = '';
        document.getElementById('treasure').value = '';
        document.getElementById('equipment').value = '';
        document.getElementById('provisions').value = '';

        enemies.forEach((_, idx) => resetEnemy(idx));
        syncPlayerInputs();
        logMessage('New game started. Roll results applied.');
        renderPotionStatus();
        selectPotion();
      });
    };

    // Wiring ----------------------------------------------------------------
    document.getElementById('eatMeal').addEventListener('click', handleEatMeal);
    document.getElementById('escape').addEventListener('click', escapeCombat);
    document.getElementById('testLuck').addEventListener('click', () => {
      const contextChoice = prompt('Test Luck context: 1) General 2) After hitting enemy 3) After taking damage');
      if (contextChoice === '2') {
        const index = parseInt(prompt('Which enemy number (1-6)?'), 10) - 1;
        if (index >= 0 && index < enemies.length) {
          testLuck({ type: 'playerHitEnemy', index, updateEnemyDisplay: () => updateEnemyInputs(index) });
        } else {
          alert('Invalid enemy number.');
        }
      } else if (contextChoice === '3') {
        testLuck({ type: 'playerHitByEnemy', index: null, updateEnemyDisplay: () => {} });
      } else {
        testLuck();
      }
    });
    document.getElementById('newGame').addEventListener('click', newGame);
    document.getElementById('usePotion').addEventListener('click', applyPotion);

    buildMonsterBoxes();
    bindPlayerInputs();
    enemies.forEach((_, index) => {
      document.getElementById(`attack-${index}`).addEventListener('click', () => performAttack(index));
    });

    updateInitialStatsDisplay();
    renderPotionStatus();
    syncPlayerInputs();
  </script>
</body>
</html>
